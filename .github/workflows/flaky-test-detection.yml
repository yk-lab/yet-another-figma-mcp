name: Flaky Test Detection
permissions:
  contents: read
  issues: write
on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 9:00 JST (æ—¥æ›œæ—¥ 24:00 UTC)
    - cron: "0 0 * * 1"
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
jobs:
  flaky-test-detection:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
      - name: Install dependencies
        run: uv sync --group dev
      - name: Run tests with random order (multiple seeds)
        id: random-tests
        run: |
          echo "=== Run 1: Random seed ==="
          uv run pytest -v -p randomly
          echo "=== Run 2: Different random seed ==="
          uv run pytest -v -p randomly
          echo "=== Run 3: Another random seed ==="
          uv run pytest -v -p randomly
      - name: Run flake finder on critical tests
        id: flake-finder
        run: |
          uv run pytest tests/integration/ --flake-finder --flake-runs=5 -v
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const today = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”´ Flaky test detected (${today})`,
              body: `## Flaky Test Detection Failed

            The weekly flaky test detection workflow has detected unstable tests.

            **Workflow Run:** ${runUrl}

            ## Next Steps

            1. Check the workflow logs to identify which tests failed
            2. Look for the \`--randomly-seed\` value to reproduce the failure
            3. Fix the test or the underlying code issue

            ## Reproducing the Failure

            \`\`\`bash
            # Use the seed from the failed run
            uv run pytest -v --randomly-seed=<seed-from-logs>
            \`\`\`
            `,
              labels: ['bug', 'flaky-test']
            });
